
IF OBJECT_ID(N'[__EFMigrationsHistory]') IS NULL
BEGIN
    CREATE TABLE [__EFMigrationsHistory] (
        [MigrationId] nvarchar(150) NOT NULL,
        [ProductVersion] nvarchar(32) NOT NULL,
        CONSTRAINT [PK___EFMigrationsHistory] PRIMARY KEY ([MigrationId])
    );
END;
GO

BEGIN TRANSACTION;
GO

CREATE TABLE [ChuongTrinhHoc] (
    [IdChuongTrinhHoc] nvarchar(100) NOT NULL DEFAULT ((newid())),
    [TenChuongTrinhHoc] nvarchar(100) NULL,
    CONSTRAINT [PK_ChuongTrinhHoc] PRIMARY KEY ([IdChuongTrinhHoc])
);
GO

CREATE TABLE [Khoa] (
    [IdKhoa] nvarchar(100) NOT NULL DEFAULT ((newid())),
    [TenKhoa] nvarchar(100) NULL,
    CONSTRAINT [PK_Khoa] PRIMARY KEY ([IdKhoa])
);
GO

CREATE TABLE [ThoiGian] (
    [IdThoiGian] nvarchar(100) NOT NULL DEFAULT ((newid())),
    [NgayBatDau] date NOT NULL,
    [NgayKetThuc] date NOT NULL,
    CONSTRAINT [PK_ThoiGian] PRIMARY KEY ([IdThoiGian])
);
GO

CREATE TABLE [SinhVien] (
    [IdSinhVien] nvarchar(100) NOT NULL DEFAULT ((newid())),
    [HoTen] nvarchar(100) NOT NULL,
    [Lop] nvarchar(50) NOT NULL,
    [NgaySinh] date NULL,
    [DiaChi] nvarchar(255) NULL,
    [IdChuongTrinhHoc] nvarchar(100) NULL,
    CONSTRAINT [PK_SinhVien] PRIMARY KEY ([IdSinhVien]),
    CONSTRAINT [FK_SinhVien_ChuongTrinhHoc_IdChuongTrinhHoc] FOREIGN KEY ([IdChuongTrinhHoc]) REFERENCES [ChuongTrinhHoc] ([IdChuongTrinhHoc])
);
GO

CREATE TABLE [GiaoVien] (
    [IdGiaoVien] nvarchar(100) NOT NULL DEFAULT ((newid())),
    [TenGiaoVien] nvarchar(100) NOT NULL,
    [Email] nvarchar(100) NULL,
    [SoDienThoai] nvarchar(15) NULL,
    [IdKhoa] nvarchar(100) NULL,
    CONSTRAINT [PK_GiaoVien] PRIMARY KEY ([IdGiaoVien]),
    CONSTRAINT [FK_GiaoVien_Khoa_IdKhoa] FOREIGN KEY ([IdKhoa]) REFERENCES [Khoa] ([IdKhoa])
);
GO

CREATE TABLE [MonHoc] (
    [IdMonHoc] nvarchar(100) NOT NULL DEFAULT ((newid())),
    [TenMonHoc] nvarchar(100) NULL,
    [SoTinChi] int NULL,
    [SoTietHoc] int NULL,
    [IdKhoa] nvarchar(100) NULL,
    CONSTRAINT [PK_MonHoc] PRIMARY KEY ([IdMonHoc]),
    CONSTRAINT [FK_MonHoc_Khoa_IdKhoa] FOREIGN KEY ([IdKhoa]) REFERENCES [Khoa] ([IdKhoa])
);
GO

CREATE TABLE [LopHocPhan] (
    [IdLopHocPhan] nvarchar(100) NOT NULL DEFAULT ((newid())),
    [TenHocPhan] nvarchar(100) NOT NULL,
    [IdGiaoVien] nvarchar(100) NULL,
    [IdMonHoc] nvarchar(100) NULL,
    CONSTRAINT [PK_LopHocPhan] PRIMARY KEY ([IdLopHocPhan]),
    CONSTRAINT [FK_LopHocPhan_GiaoVien_IdGiaoVien] FOREIGN KEY ([IdGiaoVien]) REFERENCES [GiaoVien] ([IdGiaoVien])
);
GO

CREATE TABLE [ChuongTrinhHoc_MonHoc] (
    [IdCTHMonHoc] nvarchar(100) NOT NULL DEFAULT ((newid())),
    [IdChuongTrinhHoc] nvarchar(100) NULL,
    [IdMonHoc] nvarchar(100) NULL,
    CONSTRAINT [PK_ChuongTrinhHoc_MonHoc] PRIMARY KEY ([IdCTHMonHoc]),
    CONSTRAINT [FK_ChuongTrinhHoc_MonHoc_ChuongTrinhHoc_IdChuongTrinhHoc] FOREIGN KEY ([IdChuongTrinhHoc]) REFERENCES [ChuongTrinhHoc] ([IdChuongTrinhHoc]),
    CONSTRAINT [FK_ChuongTrinhHoc_MonHoc_MonHoc_IdMonHoc] FOREIGN KEY ([IdMonHoc]) REFERENCES [MonHoc] ([IdMonHoc])
);
GO

CREATE TABLE [Diem] (
    [IdDiem] nvarchar(100) NOT NULL DEFAULT ((newid())),
    [IdLopHocPhan] nvarchar(100) NULL,
    [IdSinhVien] nvarchar(100) NULL,
    [DiemQuaTrinh] decimal(5,2) NULL,
    [DiemKetThuc] decimal(5,2) NULL,
    [DiemTongKet] decimal(5,2) NULL,
    [LanHoc] int NULL,
    CONSTRAINT [PK_Diem] PRIMARY KEY ([IdDiem]),
    CONSTRAINT [FK_Diem_LopHocPhan_IdLopHocPhan] FOREIGN KEY ([IdLopHocPhan]) REFERENCES [LopHocPhan] ([IdLopHocPhan]),
    CONSTRAINT [FK_Diem_SinhVien_IdSinhVien] FOREIGN KEY ([IdSinhVien]) REFERENCES [SinhVien] ([IdSinhVien])
);
GO

CREATE TABLE [SinhVien_LopHocPhan] (
    [IdSinhVienLopHP] nvarchar(100) NOT NULL DEFAULT ((newid())),
    [IdSinhVien] nvarchar(100) NULL,
    [IdLopHocPhan] nvarchar(100) NULL,
    CONSTRAINT [PK_SinhVien_LopHocPhan] PRIMARY KEY ([IdSinhVienLopHP]),
    CONSTRAINT [FK_SinhVien_LopHocPhan_LopHocPhan_IdLopHocPhan] FOREIGN KEY ([IdLopHocPhan]) REFERENCES [LopHocPhan] ([IdLopHocPhan]),
    CONSTRAINT [FK_SinhVien_LopHocPhan_SinhVien_IdSinhVien] FOREIGN KEY ([IdSinhVien]) REFERENCES [SinhVien] ([IdSinhVien])
);
GO

CREATE TABLE [ThoiGian_LopHocPhan] (
    [IdThoigianLopHP] nvarchar(100) NOT NULL DEFAULT ((newid())),
    [IdLopHocPhan] nvarchar(100) NULL,
    [IdThoiGian] nvarchar(100) NULL,
    CONSTRAINT [PK_ThoiGian_LopHocPhan] PRIMARY KEY ([IdThoigianLopHP]),
    CONSTRAINT [FK_ThoiGian_LopHocPhan_LopHocPhan_IdLopHocPhan] FOREIGN KEY ([IdLopHocPhan]) REFERENCES [LopHocPhan] ([IdLopHocPhan]),
    CONSTRAINT [FK_ThoiGian_LopHocPhan_ThoiGian_IdThoiGian] FOREIGN KEY ([IdThoiGian]) REFERENCES [ThoiGian] ([IdThoiGian])
);
GO

CREATE INDEX [IX_ChuongTrinhHoc_MonHoc_IdChuongTrinhHoc] ON [ChuongTrinhHoc_MonHoc] ([IdChuongTrinhHoc]);
GO

CREATE INDEX [IX_ChuongTrinhHoc_MonHoc_IdMonHoc] ON [ChuongTrinhHoc_MonHoc] ([IdMonHoc]);
GO

CREATE INDEX [IX_Diem_IdLopHocPhan] ON [Diem] ([IdLopHocPhan]);
GO

CREATE INDEX [IX_Diem_IdSinhVien] ON [Diem] ([IdSinhVien]);
GO

CREATE INDEX [IX_GiaoVien_IdKhoa] ON [GiaoVien] ([IdKhoa]);
GO

CREATE INDEX [IX_LopHocPhan_IdGiaoVien] ON [LopHocPhan] ([IdGiaoVien]);
GO

CREATE INDEX [IX_MonHoc_IdKhoa] ON [MonHoc] ([IdKhoa]);
GO

CREATE INDEX [IX_SinhVien_IdChuongTrinhHoc] ON [SinhVien] ([IdChuongTrinhHoc]);
GO

CREATE INDEX [IX_SinhVien_LopHocPhan_IdLopHocPhan] ON [SinhVien_LopHocPhan] ([IdLopHocPhan]);
GO

CREATE INDEX [IX_SinhVien_LopHocPhan_IdSinhVien] ON [SinhVien_LopHocPhan] ([IdSinhVien]);
GO

CREATE INDEX [IX_ThoiGian_LopHocPhan_IdLopHocPhan] ON [ThoiGian_LopHocPhan] ([IdLopHocPhan]);
GO

CREATE INDEX [IX_ThoiGian_LopHocPhan_IdThoiGian] ON [ThoiGian_LopHocPhan] ([IdThoiGian]);
GO

INSERT INTO [__EFMigrationsHistory] ([MigrationId], [ProductVersion])
VALUES (N'20241024062559_init', N'8.0.8');
GO

COMMIT;
GO

BEGIN TRANSACTION;
GO

INSERT INTO [__EFMigrationsHistory] ([MigrationId], [ProductVersion])
VALUES (N'20241024073949_fixNameVar_LinkedToTable', N'8.0.8');
GO

COMMIT;
GO

BEGIN TRANSACTION;
GO

CREATE INDEX [IX_LopHocPhan_IdMonHoc] ON [LopHocPhan] ([IdMonHoc]);
GO

ALTER TABLE [LopHocPhan] ADD CONSTRAINT [FK_LopHocPhan_MonHoc_IdMonHoc] FOREIGN KEY ([IdMonHoc]) REFERENCES [MonHoc] ([IdMonHoc]);
GO

INSERT INTO [__EFMigrationsHistory] ([MigrationId], [ProductVersion])
VALUES (N'20241024075735_link_lhp_mh', N'8.0.8');
GO

COMMIT;
GO

BEGIN TRANSACTION;
GO

CREATE TABLE [DangKyNguyenVong] (
    [IdDangKyNguyenVong] nvarchar(100) NOT NULL DEFAULT ((newid())),
    [IdSinhVien] nvarchar(100) NOT NULL,
    [IdMonHoc] nvarchar(100) NOT NULL,
    CONSTRAINT [PK_DangKyNguyenVong] PRIMARY KEY ([IdDangKyNguyenVong]),
    CONSTRAINT [FK_DangKyNguyenVong_MonHoc_IdMonHoc] FOREIGN KEY ([IdMonHoc]) REFERENCES [MonHoc] ([IdMonHoc]) ON DELETE CASCADE,
    CONSTRAINT [FK_DangKyNguyenVong_SinhVien_IdSinhVien] FOREIGN KEY ([IdSinhVien]) REFERENCES [SinhVien] ([IdSinhVien]) ON DELETE CASCADE
);
GO

CREATE INDEX [IX_DangKyNguyenVong_IdMonHoc] ON [DangKyNguyenVong] ([IdMonHoc]);
GO

CREATE INDEX [IX_DangKyNguyenVong_IdSinhVien] ON [DangKyNguyenVong] ([IdSinhVien]);
GO

INSERT INTO [__EFMigrationsHistory] ([MigrationId], [ProductVersion])
VALUES (N'20241024082129_create_table_dang_ki_nguyen_vong', N'8.0.8');
GO

COMMIT;
GO

BEGIN TRANSACTION;
GO

ALTER TABLE [SinhVien] ADD [IdKhoa] nvarchar(100) NULL;
GO

CREATE INDEX [IX_SinhVien_IdKhoa] ON [SinhVien] ([IdKhoa]);
GO

ALTER TABLE [SinhVien] ADD CONSTRAINT [FK_SinhVien_Khoa_IdKhoa] FOREIGN KEY ([IdKhoa]) REFERENCES [Khoa] ([IdKhoa]);
GO

INSERT INTO [__EFMigrationsHistory] ([MigrationId], [ProductVersion])
VALUES (N'20241024145726_add_khoa_vao_sinh_vien', N'8.0.8');
GO

COMMIT;
GO

BEGIN TRANSACTION;
GO

ALTER TABLE [DangKyNguyenVong] ADD [TrangThai] bit NOT NULL DEFAULT CAST(0 AS bit);
GO

INSERT INTO [__EFMigrationsHistory] ([MigrationId], [ProductVersion])
VALUES (N'20241026065029_AddCotTrangThai_Vao_Nguyen_Vong', N'8.0.8');
GO

COMMIT;
GO

BEGIN TRANSACTION;
GO

DECLARE @var0 sysname;
SELECT @var0 = [d].[name]
FROM [sys].[default_constraints] [d]
INNER JOIN [sys].[columns] [c] ON [d].[parent_column_id] = [c].[column_id] AND [d].[parent_object_id] = [c].[object_id]
WHERE ([d].[parent_object_id] = OBJECT_ID(N'[Diem]') AND [c].[name] = N'IdDiem');
IF @var0 IS NOT NULL EXEC(N'ALTER TABLE [Diem] DROP CONSTRAINT [' + @var0 + '];');
GO

INSERT INTO [__EFMigrationsHistory] ([MigrationId], [ProductVersion])
VALUES (N'20241029044257_rm_newid_sv', N'8.0.8');
GO

COMMIT;
GO

BEGIN TRANSACTION;
GO

DECLARE @var1 sysname;
SELECT @var1 = [d].[name]
FROM [sys].[default_constraints] [d]
INNER JOIN [sys].[columns] [c] ON [d].[parent_column_id] = [c].[column_id] AND [d].[parent_object_id] = [c].[object_id]
WHERE ([d].[parent_object_id] = OBJECT_ID(N'[MonHoc]') AND [c].[name] = N'IdMonHoc');
IF @var1 IS NOT NULL EXEC(N'ALTER TABLE [MonHoc] DROP CONSTRAINT [' + @var1 + '];');
GO

DECLARE @var2 sysname;
SELECT @var2 = [d].[name]
FROM [sys].[default_constraints] [d]
INNER JOIN [sys].[columns] [c] ON [d].[parent_column_id] = [c].[column_id] AND [d].[parent_object_id] = [c].[object_id]
WHERE ([d].[parent_object_id] = OBJECT_ID(N'[LopHocPhan]') AND [c].[name] = N'IdLopHocPhan');
IF @var2 IS NOT NULL EXEC(N'ALTER TABLE [LopHocPhan] DROP CONSTRAINT [' + @var2 + '];');
GO

DECLARE @var3 sysname;
SELECT @var3 = [d].[name]
FROM [sys].[default_constraints] [d]
INNER JOIN [sys].[columns] [c] ON [d].[parent_column_id] = [c].[column_id] AND [d].[parent_object_id] = [c].[object_id]
WHERE ([d].[parent_object_id] = OBJECT_ID(N'[GiaoVien]') AND [c].[name] = N'IdGiaoVien');
IF @var3 IS NOT NULL EXEC(N'ALTER TABLE [GiaoVien] DROP CONSTRAINT [' + @var3 + '];');
GO

INSERT INTO [__EFMigrationsHistory] ([MigrationId], [ProductVersion])
VALUES (N'20241029055509_rm_newid_some_table', N'8.0.8');
GO

COMMIT;
GO

BEGIN TRANSACTION;
GO

DECLARE @var4 sysname;
SELECT @var4 = [d].[name]
FROM [sys].[default_constraints] [d]
INNER JOIN [sys].[columns] [c] ON [d].[parent_column_id] = [c].[column_id] AND [d].[parent_object_id] = [c].[object_id]
WHERE ([d].[parent_object_id] = OBJECT_ID(N'[SinhVien]') AND [c].[name] = N'IdSinhVien');
IF @var4 IS NOT NULL EXEC(N'ALTER TABLE [SinhVien] DROP CONSTRAINT [' + @var4 + '];');
GO

DECLARE @var5 sysname;
SELECT @var5 = [d].[name]
FROM [sys].[default_constraints] [d]
INNER JOIN [sys].[columns] [c] ON [d].[parent_column_id] = [c].[column_id] AND [d].[parent_object_id] = [c].[object_id]
WHERE ([d].[parent_object_id] = OBJECT_ID(N'[Khoa]') AND [c].[name] = N'IdKhoa');
IF @var5 IS NOT NULL EXEC(N'ALTER TABLE [Khoa] DROP CONSTRAINT [' + @var5 + '];');
GO

DECLARE @var6 sysname;
SELECT @var6 = [d].[name]
FROM [sys].[default_constraints] [d]
INNER JOIN [sys].[columns] [c] ON [d].[parent_column_id] = [c].[column_id] AND [d].[parent_object_id] = [c].[object_id]
WHERE ([d].[parent_object_id] = OBJECT_ID(N'[Diem]') AND [c].[name] = N'IdDiem');
IF @var6 IS NOT NULL EXEC(N'ALTER TABLE [Diem] DROP CONSTRAINT [' + @var6 + '];');
ALTER TABLE [Diem] ADD DEFAULT ((newid())) FOR [IdDiem];
GO

INSERT INTO [__EFMigrationsHistory] ([MigrationId], [ProductVersion])
VALUES (N'20241029060010_fix_db_la_cuoi', N'8.0.8');
GO

COMMIT;
GO


